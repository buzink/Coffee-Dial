<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Dial - Brew Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Outfit', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d6ccc2; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #57534e; }
        ::-webkit-scrollbar-thumb:hover { background: #a18e84; }
        .dragging { opacity: 0.5; background-color: #e6dfd9; border: 2px dashed #8c7365; }
        .dark .dragging { background-color: #44403c; border-color: #a8a29e; }
        input:focus, select:focus, textarea:focus { outline: none; ring: 2px; border-color: #b08968; box-shadow: 0 0 0 3px rgba(176, 137, 104, 0.2); }
        .editing-mode { border: 2px solid #ea580c !important; }
        th.filterable { position: relative; }
        th.filterable:hover::after { content: '\f0b0'; font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 0.7em; margin-left: 6px; opacity: 0.5; }
        #filterDropdown { z-index: 50; animation: fadeIn 0.1s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .chevron-rotate { transition: transform 0.3s ease; }
        .group[aria-expanded="true"] .chevron-rotate { transform: rotate(180deg); }
    </style>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { coffee: { 50: '#fdf8f6', 100: '#f2e8e5', 200: '#eaddd7', 300: '#e0ccbb', 400: '#d2bab0', 500: '#a18e84', 600: '#8c7365', 700: '#7f5539', 800: '#9c6644', 900: '#4a3b32', } } } } }
    </script>
</head>
<body class="bg-[#fcfbf9] text-coffee-900 dark:bg-[#1c1917] dark:text-[#e7e5e4] min-h-screen pb-20" onclick="closeFilterMenu(event)">

    <!-- Header -->
    <header class="bg-white dark:bg-[#292524] shadow-sm border-b border-coffee-200 dark:border-[#44403c] sticky top-0 z-20 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-mug-hot text-coffee-700 dark:text-[#d6ccc2] text-2xl"></i>
                <h1 class="text-2xl font-bold tracking-tight text-coffee-900 dark:text-white">Coffee Dial</h1>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Auth Section -->
                <div id="authContainer">
                    <button id="loginBtn" onclick="googleLogin()" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-colors">
                        <i class="fa-brands fa-google"></i> Sign In
                    </button>
                    <div id="userProfile" class="hidden flex items-center gap-3">
                        <span id="userName" class="text-sm font-medium hidden sm:block"></span>
                        <img id="userAvatar" src="" alt="User" class="w-8 h-8 rounded-full border border-coffee-200 dark:border-[#44403c]">
                        <button onclick="googleLogout()" class="text-xs text-red-500 hover:text-red-700 underline">Sign Out</button>
                    </div>
                </div>

                <!-- Dark Mode Toggle -->
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-coffee-50 dark:hover:bg-[#44403c] transition-colors text-coffee-600 dark:text-[#a8a29e]" title="Toggle Theme">
                    <i class="fa-solid fa-moon dark:hidden"></i><i class="fa-solid fa-sun hidden dark:inline"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 relative">
        
        <!-- Add/Edit Coffee Form Container -->
        <div id="formContainer" class="bg-white dark:bg-[#292524] rounded-xl shadow-lg border border-coffee-100 dark:border-[#44403c] mb-8 transition-all duration-300 overflow-hidden group" aria-expanded="false">
            
            <!-- Accordion Header -->
            <div onclick="toggleForm()" class="p-6 cursor-pointer flex justify-between items-center bg-coffee-50/50 dark:bg-[#292524] hover:bg-coffee-50 dark:hover:bg-[#34302e] transition-colors">
                <h2 id="formTitle" class="text-lg font-semibold flex items-center gap-2 text-coffee-900 dark:text-white select-none">
                    <i class="fa-solid fa-plus-circle text-coffee-700 dark:text-[#d6ccc2]"></i> 
                    <span>Add New Brew</span>
                </h2>
                <div class="flex items-center gap-4">
                    <button id="cancelEditBtn" onclick="resetFormState(event)" class="hidden text-xs text-red-500 hover:text-red-700 dark:text-red-400 underline z-10 relative">
                        Cancel Edit
                    </button>
                    <i class="fa-solid fa-chevron-down text-coffee-400 chevron-rotate"></i>
                </div>
            </div>

            <!-- Accordion Content -->
            <div id="formContent" class="hidden px-6 pb-6 border-t border-coffee-100 dark:border-[#44403c]">
                <form id="coffeeForm" onsubmit="handleFormSubmit(event)" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
                    <input type="hidden" id="editId" name="editId" value="">

                    <!-- Row 1: Basic Info -->
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-medium text-coffee-600 dark:text-[#a8a29e] mb-1 uppercase tracking-wide">Coffee Name</label>
                        <input type="text" id="name" name="name" required placeholder="e.g. Ethiopia Yirgacheffe" class="w-full bg-coffee-50 dark:bg-[#1c1917] border border-coffee-200 dark:border-[#44403c] rounded-lg px-3 py-2 text-sm text-coffee-900 dark:text-white placeholder-coffee-400 dark:placeholder-[#57534e] focus:bg-white dark:focus:bg-[#0c0a09] transition-colors">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-coffee-600 dark:text-[#a8a29e] mb-1 uppercase tracking-wide">Bean Type / Origin</label>
                        <input type="text" id="beanType" name="beanType" placeholder="e.g. Washed" class="w-full bg-coffee-50 dark:bg-[#1c1917] border border-coffee-200 dark:border-[#44403c] rounded-lg px-3 py-2 text-sm text-coffee-900 dark:text-white placeholder-coffee-400 dark:placeholder-[#57534e] focus:bg-white dark:focus:bg-[#0c0a09] transition-colors">
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-coffee-600 dark:text-[#a8a29e] mb-1 uppercase tracking-wide">Roast Type</label>
                        <select id="roastType" name="roastType" class="w-full bg-coffee-50 dark:bg-[#1c1917] border border-coffee-200 dark:border-[#44403c] rounded-lg px-3 py-2 text-sm text-coffee-900 dark:text-white focus:bg-white dark:focus:bg-[#0c0a09] cursor-pointer">
                            <option value="Light">Light</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Medium-Dark">Medium-Dark</option>
                            <option value="Dark">Dark</option>
                        </select>
                    </div>

                    <!-- Row 2: Method & Grind -->
                    <div>
                        <label class="block text-xs font-medium text-coffee-600 dark:text-[#a8a29e] mb-1 uppercase tracking-wide">Brewing Method</label>
                        <select id="method" name="method" required class="w-full bg-coffee-50 dark:bg-[#1c1917] border border-coffee-200 dark:border-[#44403c] rounded-lg px-3 py-2 text-sm text-coffee-900 dark:text-white focus:bg-white dark:focus:bg-[#0c0a09] cursor-pointer">
                            <option value="Espresso">Espresso</option>
                            <option value="V60">V60</option>
                            <option value="Clever Dripper">Clever Dripper</option>
                            <option value="Aeropress">Aeropress</option>
                            <option value="OXO Rapid Brewer">OXO Rapid Brewer</option>
                            <option value="French Press">French Press</option>
                            <option value="Chemex">Chemex</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-coffee-600 dark:text-[#a8a29e] mb-1 uppercase tracking-wide">Grind Size</label>
                        <input type="number" step="any" id="grind" name="grind" required placeholder="e.g. 14" class="w-full bg-coffee-50 dark:bg-[#1c1917] border border-coffee-200 dark:border-[#44403c] rounded-lg px-3 py-2 text-sm text-coffee-900 dark:text-white focus:bg-white dark:focus:bg-[#0c0a09]">
                    </div>

                    <!-- Recipe Block: Weight / Ratio / Yield -->
                    <div class="col-span-1 md:col-span-2 lg:col-span-2 grid grid-cols-3 gap-2 bg-coffee-50/50 dark:bg-[#201d1b] p-2 rounded-lg border border-coffee-100 dark:border-[#44403c]">
                        <div>
                            <label class="block text-[10px] font-bold text-coffee-500 dark:text-[#78716c] mb-1 uppercase text-center">In (g)</label>
                            <input type="number" step="any" id="inputWeight" name="weight" oninput="handleRecipeInput('weight')" required placeholder="18" class="w-full text-center font-mono bg-white dark:bg-[#1c1917] border border-coffee-200 dark:border-[#44403c] rounded px-2 py-1.5 text-sm text-coffee-900 dark:text-white focus:ring-1 focus:ring-coffee-500">
                        </div>
                        <div class="relative">
                            <label class="block text-[10px] font-bold text-coffee-500 dark:text-[#78716c] mb-1 uppercase text-center">Ratio 1:X</label>
                            <input type="number" step="any" id="inputRatio" name="ratio" oninput="handleRecipeInput('ratio')" required placeholder="16" class="w-full text-center font-mono bg-white dark:bg-[#1c1917] border border-coffee-200 dark:border-[#44403c] rounded px-2 py-1.5 text-sm text-coffee-900 dark:text-white focus:ring-1 focus:ring-coffee-500">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-coffee-500 dark:text-[#78716c] mb-1 uppercase text-center">Out (g)</label>
                            <input type="number" step="any" id="inputYield" name="yield" oninput="handleRecipeInput('yield')" placeholder="288" class="w-full text-center font-mono bg-white dark:bg-[#1c1917] border border-coffee-200 dark:border-[#44403c] rounded px-2 py-1.5 text-sm text-coffee-900 dark:text-white focus:ring-1 focus:ring-coffee-500">
                        </div>
                    </div>

                    <!-- Row 3: Time & Temp -->
                    <div>
                        <label class="block text-xs font-medium text-coffee-600 dark:text-[#a8a29e] mb-1 uppercase tracking-wide">Time (Sec)</label>
                        <input type="number" step="any" id="time" name="time" required placeholder="e.g. 180" class="w-full bg-coffee-50 dark:bg-[#1c1917] border border-coffee-200 dark:border-[#44403c] rounded-lg px-3 py-2 text-sm text-coffee-900 dark:text-white focus:bg-white dark:focus:bg-[#0c0a09]">
                    </div>

                    <div class="relative">
                        <div class="flex justify-between items-end mb-1">
                            <label class="block text-xs font-medium text-coffee-600 dark:text-[#a8a29e] uppercase tracking-wide">Temp</label>
                            <div class="flex bg-coffee-100 dark:bg-[#44403c] rounded p-0.5">
                                <button type="button" onclick="setTempMode('profile')" id="btnTempProfile" class="px-2 py-0.5 text-[10px] rounded font-bold transition-all bg-white dark:bg-[#1c1917] shadow-sm text-coffee-800 dark:text-white">Prof</button>
                                <button type="button" onclick="setTempMode('numeric')" id="btnTempNumeric" class="px-2 py-0.5 text-[10px] rounded font-bold transition-all text-coffee-500 dark:text-[#a8a29e] hover:text-coffee-700">°C</button>
                            </div>
                        </div>
                        
                        <!-- Input Containers -->
                        <div id="tempProfileContainer">
                            <select id="tempProfile" name="tempProfile" class="w-full bg-coffee-50 dark:bg-[#1c1917] border border-coffee-200 dark:border-[#44403c] rounded-lg px-3 py-2 text-sm text-coffee-900 dark:text-white focus:bg-white dark:focus:bg-[#0c0a09] cursor-pointer">
                                <option value="L3">L3 (Low)</option>
                                <option value="L2">L2</option>
                                <option value="L1">L1</option>
                                <option value="M" selected>M (Medium)</option>
                                <option value="H1">H1</option>
                                <option value="H2">H2</option>
                                <option value="H3">H3 (High)</option>
                            </select>
                        </div>
                        <div id="tempNumericContainer" class="hidden">
                            <input type="number" step="any" id="tempNumeric" name="tempNumeric" placeholder="e.g. 93" class="w-full bg-coffee-50 dark:bg-[#1c1917] border border-coffee-200 dark:border-[#44403c] rounded-lg px-3 py-2 text-sm text-coffee-900 dark:text-white focus:bg-white dark:focus:bg-[#0c0a09]">
                        </div>
                        <input type="hidden" id="tempMode" name="tempMode" value="profile">
                    </div>

                    <div class="col-span-1 md:col-span-2 lg:col-span-4">
                        <label class="block text-xs font-medium text-coffee-600 dark:text-[#a8a29e] mb-1 uppercase tracking-wide">Tasting Notes</label>
                        <input type="text" id="notes" name="notes" placeholder="e.g. Floral, fruity acidity, clean finish" class="w-full bg-coffee-50 dark:bg-[#1c1917] border border-coffee-200 dark:border-[#44403c] rounded-lg px-3 py-2 text-sm text-coffee-900 dark:text-white focus:bg-white dark:focus:bg-[#0c0a09]">
                    </div>

                    <!-- Submit -->
                    <div class="col-span-1 md:col-span-2 lg:col-span-4 flex justify-end mt-2">
                        <button type="submit" id="submitBtn" class="bg-coffee-700 hover:bg-coffee-800 dark:bg-[#57534e] dark:hover:bg-[#44403c] text-white px-6 py-2.5 rounded-lg font-medium shadow-sm transition-all flex items-center gap-2">
                            <i class="fa-solid fa-check"></i> <span>Save Brew</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Active Filters Bar (Dynamic) -->
        <div id="activeFiltersContainer" class="hidden mb-4 p-3 bg-coffee-100 dark:bg-[#292524] rounded-lg border border-coffee-200 dark:border-[#44403c] flex items-center justify-between">
            <div class="flex items-center gap-2 flex-wrap" id="activeFiltersList">
                <!-- Chips injected here -->
            </div>
            <button onclick="clearAllFilters()" class="text-xs text-coffee-600 dark:text-[#a8a29e] hover:text-red-500 whitespace-nowrap ml-2">
                Clear All
            </button>
        </div>

        <!-- Info Hint -->
        <div class="mb-2 text-xs text-coffee-500 dark:text-[#78716c] italic flex flex-col gap-1">
            <span><i class="fa-solid fa-hand-pointer mr-1"></i> Double tap Headers (Roast, Method, Temp) to filter.</span>
            <span><i class="fa-solid fa-info-circle mr-1"></i> Drag rows to reorder (only when signed in).</span>
        </div>

        <!-- Table Container -->
        <div class="bg-white dark:bg-[#292524] rounded-xl shadow-lg border border-coffee-100 dark:border-[#44403c] overflow-hidden transition-colors duration-300 relative">
            <div class="overflow-x-auto min-h-[300px]">
                <table class="w-full text-sm text-left text-coffee-900 dark:text-[#e7e5e4]">
                    <thead class="text-xs text-coffee-700 dark:text-[#a8a29e] uppercase bg-coffee-100/50 dark:bg-[#1c1917] border-b border-coffee-200 dark:border-[#44403c]">
                        <tr>
                            <th scope="col" class="px-4 py-4 w-10 text-center">
                                <i class="fa-solid fa-grip-vertical"></i>
                            </th>
                            <th scope="col" class="px-4 py-4 cursor-pointer hover:bg-coffee-100 dark:hover:bg-[#44403c] transition-colors group" onclick="sortBy('name')">
                                Coffee <i class="fa-solid fa-sort text-coffee-400 dark:text-[#57534e] group-hover:text-coffee-600 dark:group-hover:text-[#a8a29e] ml-1"></i>
                            </th>
                            <th scope="col" class="px-4 py-4 cursor-pointer hover:bg-coffee-100 dark:hover:bg-[#44403c] transition-colors group filterable" 
                                onclick="sortBy('roastType')" 
                                ondblclick="openFilterMenu(event, 'roastType')">
                                Roast <i class="fa-solid fa-sort text-coffee-400 dark:text-[#57534e] group-hover:text-coffee-600 dark:group-hover:text-[#a8a29e] ml-1"></i>
                            </th>
                            <th scope="col" class="px-4 py-4 cursor-pointer hover:bg-coffee-100 dark:hover:bg-[#44403c] transition-colors group filterable" 
                                onclick="sortBy('method')"
                                ondblclick="openFilterMenu(event, 'method')">
                                Method <i class="fa-solid fa-sort text-coffee-400 dark:text-[#57534e] group-hover:text-coffee-600 dark:group-hover:text-[#a8a29e] ml-1"></i>
                            </th>
                            <th scope="col" class="px-4 py-4 cursor-pointer hover:bg-coffee-100 dark:hover:bg-[#44403c] transition-colors group text-right" onclick="sortBy('grind')">
                                Grind <i class="fa-solid fa-sort text-coffee-400 dark:text-[#57534e] group-hover:text-coffee-600 dark:group-hover:text-[#a8a29e] ml-1"></i>
                            </th>
                            <th scope="col" class="px-4 py-4 text-center">
                                Recipe (In : Out)
                            </th>
                            <th scope="col" class="px-4 py-4 cursor-pointer hover:bg-coffee-100 dark:hover:bg-[#44403c] transition-colors group text-right" onclick="sortBy('time')">
                                Time <i class="fa-solid fa-sort text-coffee-400 dark:text-[#57534e] group-hover:text-coffee-600 dark:group-hover:text-[#a8a29e] ml-1"></i>
                            </th>
                            <th scope="col" class="px-4 py-4 cursor-pointer hover:bg-coffee-100 dark:hover:bg-[#44403c] transition-colors group text-center filterable" 
                                onclick="sortBy('temp')"
                                ondblclick="openFilterMenu(event, 'temp')">
                                Temp <i class="fa-solid fa-sort text-coffee-400 dark:text-[#57534e] group-hover:text-coffee-600 dark:group-hover:text-[#a8a29e] ml-1"></i>
                            </th>
                            <th scope="col" class="px-4 py-4">
                                Notes
                            </th>
                            <th scope="col" class="px-4 py-4 text-center w-24">
                                Action
                            </th>
                        </tr>
                    </thead>
                    <tbody id="coffeeTableBody" class="divide-y divide-coffee-50 dark:divide-[#1c1917]">
                        <!-- Rows rendered here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Filter Dropdown Menu (Absolute) -->
            <div id="filterDropdown" class="hidden absolute bg-white dark:bg-[#292524] rounded-lg shadow-xl border border-coffee-200 dark:border-[#57534e] py-1 min-w-[150px]">
                <!-- Options injected by JS -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-16 text-coffee-400 dark:text-[#57534e] absolute top-16 left-0 right-0 pointer-events-none">
                <i class="fa-solid fa-mug-saucer text-4xl mb-3 opacity-50"></i>
                <p class="text-lg font-medium">Please sign in to view your logs.</p>
                <p class="text-sm">Connect with Google to sync your coffee data.</p>
            </div>
        </div>

    </main>

    <!-- Scripts -->
    <script type="module">
        // --------------------------------------------------------
        // STEP 1: PASTE YOUR FIREBASE CONFIGURATION HERE
        // --------------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyAjKRgCrNuwaAvjOJPzTrmippI2sv5QG6M",
  authDomain: "coffee-dial-app-9db38.firebaseapp.com",
  projectId: "coffee-dial-app-9db38",
  storageBucket: "coffee-dial-app-9db38.firebasestorage.app",
  messagingSenderId: "513325852224",
  appId: "1:513325852224:web:0af5f15c4968a5bfad61a5"
};
        // --------------------------------------------------------

        // Firebase Imports (Direct from CDN for GitHub Pages compatibility)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- State Management ---
        let coffees = []; 
        let currentUser = null;
        let currentSort = { key: null, direction: 'asc' };
        let activeFilters = {
            method: null,
            temp: null,
            roastType: null
        };

        // --- Auth Functions ---
        window.googleLogin = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed", error);
                alert("Login failed: " + error.message);
            }
        };

        window.googleLogout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed", error);
            }
        };

        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // User is signed in
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('userProfile').classList.remove('hidden');
                document.getElementById('userName').textContent = user.displayName;
                document.getElementById('userAvatar').src = user.photoURL;
                
                // Start listening to their private data
                startDataListener(user.uid);
            } else {
                // User is signed out
                document.getElementById('loginBtn').classList.remove('hidden');
                document.getElementById('userProfile').classList.add('hidden');
                coffees = [];
                renderTable();
            }
        });

        // --- Firestore Data Listener ---
        function startDataListener(uid) {
            // Path: users/{uid}/coffees
            // This matches the Security Rules: allow read/write if request.auth.uid == userId
            const q = query(collection(db, "users", uid, "coffees"));
            
            onSnapshot(q, (snapshot) => {
                coffees = [];
                snapshot.forEach((doc) => {
                    coffees.push({ id: doc.id, ...doc.data() });
                });
                // Sort by default (name or created)
                if(!currentSort.key) {
                    // Simple default sort by name for now, or add createdAt timestamp
                    coffees.sort((a,b) => (a.name || "").localeCompare(b.name || ""));
                }
                renderTable();
            }, (error) => {
                console.error("Error fetching data: ", error);
                if (error.code === 'permission-denied') {
                    alert("Permission denied. Check your Firestore Security Rules.");
                }
            });
        }

        // --- Core Functions (Updated for Firebase) ---

        window.handleFormSubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) {
                alert("Please sign in to save brews.");
                return;
            }

            const form = e.target;
            const formData = new FormData(form);
            const editId = formData.get('editId');
            
            // Logic to get correct temp based on mode
            const tempMode = formData.get('tempMode');
            let finalTemp = tempMode === 'profile' ? formData.get('tempProfile') : formData.get('tempNumeric');
            if(!finalTemp) finalTemp = "M"; 

            const coffeeData = {
                name: formData.get('name'),
                beanType: formData.get('beanType'),
                roastType: formData.get('roastType'),
                method: formData.get('method'),
                grind: parseFloat(formData.get('grind')),
                weight: parseFloat(formData.get('weight')),
                ratio: parseFloat(formData.get('ratio')),
                time: parseFloat(formData.get('time')),
                temp: finalTemp,
                notes: formData.get('notes')
            };

            try {
                if (editId) {
                    // Update
                    const docRef = doc(db, "users", currentUser.uid, "coffees", editId);
                    await updateDoc(docRef, coffeeData);
                } else {
                    // Add
                    const colRef = collection(db, "users", currentUser.uid, "coffees");
                    await addDoc(colRef, coffeeData);
                }
                resetFormState();
                // We don't need to call renderTable() because onSnapshot does it automatically
            } catch (error) {
                console.error("Error saving document: ", error);
                alert("Error saving: " + error.message);
            }
        };

        window.deleteCoffee = async (id, event) => {
            if (event) event.stopPropagation();
            if (!currentUser) return;

            if(confirm('Are you sure you want to delete this brew log?')) {
                try {
                    await deleteDoc(doc(db, "users", currentUser.uid, "coffees", id));
                    
                    const editingId = document.getElementById('editId').value;
                    if (editingId && editingId == id) {
                        resetFormState();
                    }
                } catch (error) {
                    console.error("Error removing document: ", error);
                    alert("Error deleting: " + error.message);
                }
            }
        };

        // --- Existing Logic (UI, Calc, etc) ---
        
        window.handleRecipeInput = (source) => {
            const weightEl = document.getElementById('inputWeight');
            const ratioEl = document.getElementById('inputRatio');
            const yieldEl = document.getElementById('inputYield');

            const weight = parseFloat(weightEl.value) || 0;
            const ratio = parseFloat(ratioEl.value) || 0;
            const yieldVal = parseFloat(yieldEl.value) || 0;

            if (weight === 0) return; 

            if (source === 'weight') {
                if (ratio > 0) {
                    yieldEl.value = (weight * ratio).toFixed(1);
                } else if (yieldVal > 0) {
                    ratioEl.value = (yieldVal / weight).toFixed(1);
                }
            } else if (source === 'ratio') {
                yieldEl.value = (weight * ratio).toFixed(1);
            } else if (source === 'yield') {
                if (weight > 0) {
                    ratioEl.value = (yieldVal / weight).toFixed(2); 
                }
            }
        }

        // --- Helper Functions ---
        
        // Theme
        window.initTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark'); 
            }
        }

        window.toggleTheme = () => {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Temp Mode
        window.setTempMode = (mode) => {
            const btnProfile = document.getElementById('btnTempProfile');
            const btnNumeric = document.getElementById('btnTempNumeric');
            const containerProfile = document.getElementById('tempProfileContainer');
            const containerNumeric = document.getElementById('tempNumericContainer');
            const hiddenMode = document.getElementById('tempMode');

            hiddenMode.value = mode;

            if (mode === 'profile') {
                btnProfile.classList.add('bg-white', 'dark:bg-[#1c1917]', 'shadow-sm', 'text-coffee-800', 'dark:text-white');
                btnProfile.classList.remove('text-coffee-500', 'dark:text-[#a8a29e]', 'hover:text-coffee-700');
                
                btnNumeric.classList.remove('bg-white', 'dark:bg-[#1c1917]', 'shadow-sm', 'text-coffee-800', 'dark:text-white');
                btnNumeric.classList.add('text-coffee-500', 'dark:text-[#a8a29e]', 'hover:text-coffee-700');

                containerProfile.classList.remove('hidden');
                containerNumeric.classList.add('hidden');
                document.getElementById('tempNumeric').value = ''; 
            } else {
                btnNumeric.classList.add('bg-white', 'dark:bg-[#1c1917]', 'shadow-sm', 'text-coffee-800', 'dark:text-white');
                btnNumeric.classList.remove('text-coffee-500', 'dark:text-[#a8a29e]', 'hover:text-coffee-700');
                
                btnProfile.classList.remove('bg-white', 'dark:bg-[#1c1917]', 'shadow-sm', 'text-coffee-800', 'dark:text-white');
                btnProfile.classList.add('text-coffee-500', 'dark:text-[#a8a29e]', 'hover:text-coffee-700');

                containerNumeric.classList.remove('hidden');
                containerProfile.classList.add('hidden');
            }
        }

        // Accordion
        window.toggleForm = (forceState = null) => {
            const container = document.getElementById('formContainer');
            const content = document.getElementById('formContent');
            const isExpanded = container.getAttribute('aria-expanded') === 'true';
            
            const shouldExpand = forceState !== null ? forceState : !isExpanded;

            if (shouldExpand) {
                container.setAttribute('aria-expanded', 'true');
                content.classList.remove('hidden');
            } else {
                container.setAttribute('aria-expanded', 'false');
                content.classList.add('hidden');
            }
        }

        // UI Reset
        window.resetFormState = (event) => {
            if(event) event.stopPropagation();

            const form = document.getElementById('coffeeForm');
            form.reset();
            document.getElementById('editId').value = '';
            // Reset Temp Mode default
            window.setTempMode('profile');

            document.getElementById('formContainer').classList.remove('editing-mode');
            document.getElementById('formTitle').innerHTML = '<i class="fa-solid fa-plus-circle text-coffee-700 dark:text-[#d6ccc2]"></i> <span>Add New Brew</span>';
            
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<i class="fa-solid fa-check"></i> <span>Save Brew</span>';
            btn.classList.add('bg-coffee-700', 'hover:bg-coffee-800', 'dark:bg-[#57534e]', 'dark:hover:bg-[#44403c]');
            btn.classList.remove('bg-orange-600', 'hover:bg-orange-700', 'text-white');
            
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        // Edit
        window.editCoffee = (id) => {
            const coffee = coffees.find(c => c.id === id);
            if (!coffee) return;

            document.getElementById('editId').value = coffee.id;
            document.getElementById('name').value = coffee.name;
            document.getElementById('beanType').value = coffee.beanType;
            document.getElementById('roastType').value = coffee.roastType;
            document.getElementById('method').value = coffee.method;
            document.getElementById('grind').value = coffee.grind;
            document.getElementById('inputWeight').value = coffee.weight;
            document.getElementById('inputRatio').value = coffee.ratio;
            document.getElementById('inputYield').value = (coffee.weight * coffee.ratio).toFixed(1);
            document.getElementById('time').value = coffee.time;
            document.getElementById('notes').value = coffee.notes;

            // Handle Temp Edit Logic
            const isNumeric = !isNaN(parseFloat(coffee.temp)) && isFinite(coffee.temp);
            if (isNumeric) {
                window.setTempMode('numeric');
                document.getElementById('tempNumeric').value = coffee.temp;
            } else {
                window.setTempMode('profile');
                document.getElementById('tempProfile').value = coffee.temp;
            }

            const container = document.getElementById('formContainer');
            container.classList.add('editing-mode');
            
            window.toggleForm(true);

            document.getElementById('formTitle').innerHTML = '<i class="fa-solid fa-pencil text-orange-500"></i> <span class="text-orange-500">Edit Brew</span>';
            document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-rotate"></i> <span>Update Brew</span>';
            document.getElementById('submitBtn').classList.remove('bg-coffee-700', 'hover:bg-coffee-800', 'dark:bg-[#57534e]', 'dark:hover:bg-[#44403c]');
            document.getElementById('submitBtn').classList.add('bg-orange-600', 'hover:bg-orange-700', 'text-white');
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- Table & Filtering ---

        window.openFilterMenu = (event, key) => {
            event.stopPropagation();
            const menu = document.getElementById('filterDropdown');
            const values = [...new Set(coffees.map(c => c[key]))].sort();
            if (values.length === 0) return; 

            let html = `
                <div class="px-3 py-2 text-xs font-bold text-coffee-400 dark:text-[#78716c] uppercase tracking-wide border-b border-coffee-100 dark:border-[#44403c] mb-1">
                    Filter by ${key === 'roastType' ? 'Roast' : key.charAt(0).toUpperCase() + key.slice(1)}
                </div>
                <button onclick="applyFilter('${key}', null)" class="w-full text-left px-4 py-2 text-sm hover:bg-coffee-50 dark:hover:bg-[#44403c] ${!activeFilters[key] ? 'text-coffee-700 dark:text-[#d6ccc2] font-bold' : 'text-coffee-600 dark:text-[#a8a29e]'}">
                    All
                </button>
            `;

            values.forEach(val => {
                const isActive = activeFilters[key] === val;
                html += `
                    <button onclick="applyFilter('${key}', '${val}')" class="w-full text-left px-4 py-2 text-sm hover:bg-coffee-50 dark:hover:bg-[#44403c] ${isActive ? 'text-coffee-700 dark:text-[#d6ccc2] font-bold bg-coffee-50 dark:bg-[#44403c]' : 'text-coffee-600 dark:text-[#a8a29e]'}">
                        ${val}
                    </button>
                `;
            });

            menu.innerHTML = html;
            const rect = event.currentTarget.getBoundingClientRect();
            const containerRect = event.currentTarget.closest('.relative').getBoundingClientRect();
            menu.style.top = (rect.bottom - containerRect.top + 5) + 'px';
            menu.style.left = (rect.left - containerRect.left) + 'px';
            menu.classList.remove('hidden');
        }

        window.closeFilterMenu = (event) => {
            const menu = document.getElementById('filterDropdown');
            if (!menu.contains(event.target)) {
                menu.classList.add('hidden');
            }
        }

        window.applyFilter = (key, value) => {
            activeFilters[key] = value;
            document.getElementById('filterDropdown').classList.add('hidden');
            renderTable();
            renderActiveFilters();
        }

        window.clearAllFilters = () => {
            activeFilters = { method: null, temp: null, roastType: null };
            renderTable();
            renderActiveFilters();
        }

        window.renderActiveFilters = () => {
            const container = document.getElementById('activeFiltersContainer');
            const list = document.getElementById('activeFiltersList');
            list.innerHTML = '';
            
            let hasFilters = false;
            Object.entries(activeFilters).forEach(([key, value]) => {
                if(value) {
                    hasFilters = true;
                    const displayKey = key === 'roastType' ? 'Roast' : key.charAt(0).toUpperCase() + key.slice(1);
                    const chip = document.createElement('div');
                    chip.className = 'flex items-center gap-2 bg-coffee-700 dark:bg-[#57534e] text-white text-xs px-3 py-1 rounded-full shadow-sm animate-fade-in';
                    chip.innerHTML = `
                        <span class="opacity-75">${displayKey}:</span>
                        <span class="font-bold">${value}</span>
                        <button onclick="applyFilter('${key}', null)" class="ml-1 hover:text-red-200"><i class="fa-solid fa-xmark"></i></button>
                    `;
                    list.appendChild(chip);
                }
            });

            if(hasFilters) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        window.getFilteredCoffees = () => {
            let filtered = coffees.filter(c => {
                const matchMethod = !activeFilters.method || c.method === activeFilters.method;
                const matchTemp = !activeFilters.temp || String(c.temp) === String(activeFilters.temp);
                const matchRoast = !activeFilters.roastType || c.roastType === activeFilters.roastType;
                return matchMethod && matchTemp && matchRoast;
            });

            if (currentSort.key) {
                filtered.sort((a, b) => {
                    let valA = a[currentSort.key];
                    let valB = b[currentSort.key];
                    if (currentSort.key === 'temp') {
                         const numA = parseFloat(valA);
                         const numB = parseFloat(valB);
                         if (!isNaN(numA) && !isNaN(numB)) { valA = numA; valB = numB; }
                    }
                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();
                    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            return filtered;
        }

        window.renderTable = () => {
            const tbody = document.getElementById('coffeeTableBody');
            const emptyState = document.getElementById('emptyState');
            const filteredCoffees = window.getFilteredCoffees();
            
            tbody.innerHTML = '';

            if (coffees.length === 0 && !currentUser) {
                // Not logged in
                emptyState.classList.remove('hidden');
            } else if (filteredCoffees.length === 0) {
                // Logged in but empty or filtered to empty
                emptyState.classList.remove('hidden');
                // You might want to change text here if user is logged in
                if(currentUser) {
                     emptyState.innerHTML = `<i class="fa-solid fa-mug-saucer text-4xl mb-3 opacity-50"></i><p class="text-lg font-medium">No brews found.</p><p class="text-sm">Add a new coffee above!</p>`;
                }
            } else {
                emptyState.classList.add('hidden');
                
                filteredCoffees.forEach((coffee) => {
                    const outWeight = (coffee.weight * coffee.ratio).toFixed(1);
                    const formattedTime = formatTime(coffee.time);

                    const row = document.createElement('tr');
                    row.className = `bg-white dark:bg-[#292524] hover:bg-coffee-50 dark:hover:bg-[#1c1917] border-b border-coffee-50 dark:border-[#44403c] last:border-b-0`;

                    row.innerHTML = `
                        <td class="px-4 py-4 text-center text-coffee-300 dark:text-[#57534e]">
                            <i class="fa-solid fa-cloud text-xs opacity-50"></i>
                        </td>
                        <td class="px-4 py-4">
                            <div class="font-semibold text-coffee-900 dark:text-[#e7e5e4]">${coffee.name}</div>
                            <div class="text-xs text-coffee-500 dark:text-[#a8a29e]">${coffee.beanType}</div>
                        </td>
                        <td class="px-4 py-4 cursor-pointer" ondblclick="openFilterMenu(event, 'roastType')">
                             ${getRoastBadge(coffee.roastType)}
                        </td>
                        <td class="px-4 py-4 cursor-pointer" ondblclick="openFilterMenu(event, 'method')">
                            <span class="bg-coffee-100 dark:bg-[#44403c] text-coffee-800 dark:text-[#d6ccc2] text-xs font-medium px-2.5 py-0.5 rounded border border-coffee-200 dark:border-[#57534e] pointer-events-none select-none">${coffee.method}</span>
                        </td>
                        <td class="px-4 py-4 text-right font-mono text-coffee-700 dark:text-[#d6ccc2]">
                            ${coffee.grind}
                        </td>
                        <td class="px-4 py-4 text-center">
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-coffee-500 dark:text-[#78716c] mb-1">1:${coffee.ratio}</span>
                                <div class="font-mono text-coffee-900 dark:text-[#e7e5e4] bg-coffee-50 dark:bg-[#1c1917] px-2 py-1 rounded border border-coffee-100 dark:border-[#44403c]">
                                    <span class="font-semibold text-coffee-700 dark:text-[#a8a29e]">${coffee.weight}g</span> 
                                    <i class="fa-solid fa-arrow-right text-[10px] text-coffee-400 dark:text-[#57534e] mx-1"></i>
                                    <span class="font-bold text-coffee-900 dark:text-white">${outWeight.endsWith('.0') ? parseInt(outWeight) : outWeight}g</span>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4 text-right font-mono text-coffee-600 dark:text-[#a8a29e]">
                            ${formattedTime}
                        </td>
                        <td class="px-4 py-4 text-center cursor-pointer" ondblclick="openFilterMenu(event, 'temp')">
                            ${getTempBadge(coffee.temp)}
                        </td>
                        <td class="px-4 py-4 text-sm text-coffee-600 dark:text-[#a8a29e] max-w-xs truncate" title="${coffee.notes}">
                            ${coffee.notes}
                        </td>
                        <td class="px-4 py-4 text-center w-24">
                             <div class="flex items-center justify-center gap-2">
                                <button onclick="editCoffee('${coffee.id}')" class="text-coffee-400 dark:text-[#57534e] hover:text-blue-500 dark:hover:text-blue-400 transition-colors p-2 rounded-full hover:bg-blue-50 dark:hover:bg-blue-900/20" title="Edit">
                                    <i class="fa-solid fa-pencil"></i>
                                </button>
                                <button onclick="deleteCoffee('${coffee.id}', event)" class="text-coffee-400 dark:text-[#57534e] hover:text-red-500 dark:hover:text-red-400 transition-colors p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20" title="Delete">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        window.sortBy = (key) => {
            if (currentSort.key === key) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = key;
                currentSort.direction = 'asc';
            }
            renderTable();
        }

        // Simple Formatters
        function formatTime(s) { const m=Math.floor(s/60),sc=s%60; return m>0?`${m}m ${sc}s`:`${sc}s`; }
        function getRoastBadge(r) { if(!r)return''; const m={'Light':'bg-amber-100 text-amber-800 border-amber-200 dark:bg-amber-900/40 dark:text-amber-200 dark:border-amber-800','Medium':'bg-orange-100 text-orange-800 border-orange-200 dark:bg-orange-900/40 dark:text-orange-200 dark:border-orange-800','Medium-Dark':'bg-[#d6ccc2] text-[#5e4b41] border-[#c0b4aa] dark:bg-[#57534e]/50 dark:text-[#d6ccc2] dark:border-[#57534e]','Dark':'bg-gray-800 text-gray-100 border-gray-700 dark:bg-black dark:text-gray-300 dark:border-gray-800'}; return `<span class="${m[r]||'bg-gray-100 dark:bg-gray-800'} text-xs font-medium px-2 py-0.5 rounded-full border pointer-events-none select-none">${r}</span>`; }
        function getTempBadge(t) { if(!isNaN(parseFloat(t))&&isFinite(t)){ let c='bg-gray-100 dark:bg-gray-800';if(t<90)c='bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300';else if(t<94)c='bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-300';else c='bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300';return `<span class="inline-flex items-center justify-center px-2 py-1 rounded-md ${c} text-xs font-bold shadow-sm pointer-events-none select-none font-mono">${t}°C</span>`;} const m={'L3':'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/40 dark:text-blue-300','L2':'bg-blue-50 text-blue-600 border-blue-100 dark:bg-blue-900/20 dark:text-blue-200','L1':'bg-cyan-50 text-cyan-600 border-cyan-100 dark:bg-cyan-900/20 dark:text-cyan-200','M':'bg-yellow-50 text-yellow-700 border-yellow-200 dark:bg-yellow-900/20 dark:text-yellow-200','H1':'bg-orange-50 text-orange-600 border-orange-100 dark:bg-orange-900/20 dark:text-orange-200','H2':'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/40 dark:text-orange-200','H3':'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/40 dark:text-red-300'}; return `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${m[t]||'bg-gray-100'} text-xs font-bold shadow-sm pointer-events-none select-none">${t}</span>`; }

        // Initialize Theme on load
        window.initTheme();
    </script>
</body>
</html>
